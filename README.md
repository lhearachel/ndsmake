# `nitrorom`

Create Nintendo DS ROM images from a plain-text specification.

## Table of Contents

<!--toc:start-->
- [Background](#background)
- [Install](#install)
- [Usage](#usage)
- [Specification Format](#specification-format)
- [Tip: Specification Templating](#tip-specification-templating)
- [Acknowledgments](#acknowledgments)
- [License](#license)
<!--toc:end-->

## Background

This program aims to reverse-engineer and replicate the original tooling used
by Nintendo DS game developers while providing additional functionality and sane
in portable code. Some of the features from the original tooling have been cut
in order to simplify this program; these features are detailed below with
alternatives to replicate their functionality.

## Install

A simple Makefile is included to build the application; once you have acquired a
copy of the source code, the following will produce `nitrorom`:

```bash
make
```

## Usage

The application ships with built-in help-text available:

```text
nitrorom - Create Nintendo DS ROM images

Usage: nitrorom [OPTION]... SPECFILE
       nitrorom [-V / --version]
       nitrorom [-h / --help]

Options:
  -c / --secure-crc <crc>  Specify the secure area checksum to be stored in
                           the output ROM's header. This option accepts input
                           in decimal, hexadecimal (with leading “0x”), or
                           octal (with leading “0”).
  -C / --directory <dir>   Change the working directory before reading input
                           files for insertion into the output ROM. This will
                           NOT affect loading the spec-file input.
  -o / --output <file>     Write the output ROM to a specific file. If not
                           specified, then the output ROM will be written to
                           “rom.nds” in the working directory.
```

## Specification Format

The input specification uses a custom format based on that used by the original
tooling shipped with the Nintendo DS SDK:

```sh
# This is a comment. All text from the '#' to the end of the line is ignored.
#
# A section begins with an open-brace ('{') and ends with a closing-brace ('}').
Properties {
    # Parameters for a given section are listed one-per-line and are separated
    # from their associated value by a non-zero amount of inline whitespace.
    Title       "POKEMON PL" # String-literals are wrapped in double-quotes.
    Serial      "CPUE"
    MakerCode   "01"
    PadToEnd    true         # "true" and "false" are evaluated as booleans.
    Revision    0            # Number-literals can be in decimal format...
    ROMCapacity 0x08000000   # or hexadecimal by prefixing "0x".
    ROMType     PROM         # Some fields use special string-keys.

    # Filepath-literals begin with '.' or '/'. Characters which are normally
    # restricted on Windows filesystems are considered invalid. All path-
    # separators must be Unix-style ('/'), and any whitespace character will
    # terminate the literal. If a filepath must contain spaces, then it must be
    # written as a string-literal.
    #
    # HeaderTemplate specifies a file to be loaded as an initial value for the
    # output ROM's header. It will typically include pre-set values that don't
    # change from build-to-build, such as the Nintendo logo-bitmap.
    HeaderTemplate ../platinum.us/rom_header_template.sbin

    # BootMenuBanner specifies a file to be loaded for the ROM information
    # expected by the DS's boot menu. This includes the ROM's logo and title.
    BootMenuBanner ./platinum.us/banner.bnr
}

# Open-braces for sections can also be broken to the next line.
ARM9
{
    # CodeBinary specifies the static code loaded for a coprocessor.
    CodeBinary   ./main.sbin

    # Definitions specifies some important offsets for the coprocessor and a
    # list of files to be loaded as overlays. This file typically should be
    # generated by your linker.
    Definitions  ./main_defs.sbin

    # OverlayTable specifies important offsets for each overlay for the
    # coprocessor. This file should be generated by your linker.
    OverlayTable ./main_table.sbin
}

ARM7
{
    CodeBinary  ./sub.sbin
    Definitions ./sub_defs.sbin
}

Layout {
    # The Layout section is evaluated as a set of ordered directives.
    #
    # SetTargetPath specifies the current virtual filesystem parent directory.
    # SetSourcePath specifies the current on-disk filesystem parent directory.
    SetTargetPath /
    SetSourcePath ./res/prebuilt

    # AddFile specifies a file to be loaded from on-disk and copied into the
    # output ROM. The target and source parent directories are automatically
    # prepended to the given value; e.g., the following directive would load
    # the contents of ./res/prebuilt/data/UTF16.dat into the ROM with a virtual
    # filesystem path of /data/UTF16.dat.
    AddFile "data/UTF16.dat"
}
```

A full example specification is given [here](./examples/pokeplatinum.rsf).

## Tip: Specification Templating

Specification files can be stored for your project on-disk as templates
requiring variable-substitutions at build-time:

```sh
Properties {
    Title       "${TITLE}"
    Serial      "${SERIAL}"
    MakerCode   "${MAKERCODE}"
    PadToEnd    true
    Revision    0
    ROMCapacity 0x08000000
    ROMType     PROM
}
```

Your build pipeline can make use of [`envsubst`][envsubst] from the GNU
`gettext` utilities to render a full specification to be passed to the program.
For example, using a `make` recipe:

```make
mygame.rsf: mygame.rsf.template
	cat $^ | envsubst > $@

mygame.rom: mygame.rsf
	nitrorom -o $@ $^
```

[envsubst]: https://www.gnu.org/software/gettext/manual/html_node/envsubst-Invocation.html

## Acknowledgments

- Martin Korth's [reverse-engineering documentation][gbatek] for the Nintendo DS
  cartridge header and filesystem format.

[gbatek]: https://problemkaputt.de/gbatek.htm

## License

This software is licensed under the MIT license. For details, see [the included
license text](./LICENSE).
